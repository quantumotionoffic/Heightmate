<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeightMate Pro - Grow Tall & Strong! üå±</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Bubblegum+Sans&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sky-blue: #87CEEB;
            --grass-green: #90EE90;
            --sunshine-yellow: #FFD700;
            --coral-pink: #FF6B9D;
            --cloud-white: #FFFEF9;
            --tree-brown: #8B4513;
            --deep-purple: #9B59B6;
            --ocean-teal: #3EBFB0;
            --rainbow-red: #FF6B6B;
            --rainbow-orange: #FFA500;
            --rainbow-green: #4ECDC4;
            --bg-primary: linear-gradient(180deg, var(--sky-blue) 0%, var(--cloud-white) 60%, var(--grass-green) 100%);
            --card-bg: #ffffff;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
            --text-primary: #333;
            --text-secondary: var(--tree-brown);
            --input-bg: #fff;
            --history-bg: var(--cloud-white);
            --nav-bg: rgba(255,255,255,0.95);
        }

        body.dark-mode {
            --bg-primary: linear-gradient(180deg, #1a1a2e 0%, #16213e 60%, #0f3460 100%);
            --card-bg: #1e2a3a;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.5);
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --input-bg: #2a3a4a;
            --history-bg: #1a2a3a;
            --nav-bg: rgba(20,30,45,0.97);
            --cloud-white: #1e2a3a;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            color: var(--text-primary);
            transition: background 0.4s ease, color 0.3s ease;
        }

        /* Floating clouds animation */
        .cloud { position: absolute; background: white; border-radius: 100px; opacity: 0.7; animation: float 20s infinite ease-in-out; pointer-events: none; }
        .cloud::before, .cloud::after { content: ''; position: absolute; background: white; border-radius: 100px; }
        .cloud-1 { width: 100px; height: 40px; top: 10%; left: -100px; animation-delay: 0s; }
        .cloud-1::before { width: 50px; height: 50px; top: -25px; left: 15px; }
        .cloud-1::after { width: 60px; height: 40px; top: -15px; right: 15px; }
        .cloud-2 { width: 120px; height: 45px; top: 20%; left: -120px; animation-delay: 7s; }
        .cloud-2::before { width: 60px; height: 60px; top: -30px; left: 20px; }
        .cloud-2::after { width: 70px; height: 45px; top: -20px; right: 20px; }
        @keyframes float { 0%,100% { transform: translateX(0) translateY(0); } 50% { transform: translateX(calc(100vw + 200px)) translateY(-20px); } }
        .sun { position: absolute; top: 5%; right: 10%; width: 80px; height: 80px; background: var(--sunshine-yellow); border-radius: 50%; box-shadow: 0 0 40px rgba(255,215,0,0.6); animation: pulse 4s ease-in-out infinite; pointer-events: none; }
        @keyframes pulse { 0%,100% { transform: scale(1); box-shadow: 0 0 40px rgba(255,215,0,0.6); } 50% { transform: scale(1.1); box-shadow: 0 0 60px rgba(255,215,0,0.8); } }

        /* ===================== LOGIN ===================== */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-card { background: white; border-radius: 30px; padding: 50px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 4px solid var(--deep-purple); text-align: center; animation: slideDown 0.6s ease; }
        .login-title { font-family: 'Bubblegum Sans', cursive; font-size: 3rem; color: var(--deep-purple); margin-bottom: 10px; }
        .login-subtitle { color: var(--tree-brown); font-size: 1.2rem; margin-bottom: 30px; }
        .input-field { width: 100%; padding: 15px; border: 3px solid var(--ocean-teal); border-radius: 20px; font-size: 1.1rem; font-family: 'Fredoka', sans-serif; margin-bottom: 15px; transition: all 0.3s; background: var(--input-bg); color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--coral-pink); box-shadow: 0 0 15px rgba(255,107,157,0.3); }
        .btn { background: linear-gradient(135deg, var(--coral-pink), var(--sunshine-yellow)); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.3rem; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Fredoka', sans-serif; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 100%; margin-top: 10px; }
        .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .toggle-auth { margin-top: 20px; color: var(--deep-purple); cursor: pointer; text-decoration: underline; }
        .toggle-auth:hover { color: var(--coral-pink); }

        /* ===================== TOP NAV / SETTINGS BAR ===================== */
        .top-nav {
            position: sticky;
            top: 0;
            z-index: 200;
            background: var(--nav-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 3px solid rgba(155,89,182,0.2);
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .top-nav.active { display: flex; }
        .nav-brand { font-family: 'Bubblegum Sans', cursive; font-size: 1.6rem; color: var(--deep-purple); }
        .nav-actions { display: flex; align-items: center; gap: 10px; }

        .nav-btn {
            background: none;
            border: 2.5px solid var(--deep-purple);
            color: var(--deep-purple);
            border-radius: 50%;
            width: 42px; height: 42px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .nav-btn:hover { background: var(--deep-purple); color: white; transform: scale(1.1); }
        .nav-btn.active-btn { background: var(--deep-purple); color: white; }

        .settings-dropdown {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            border: 3px solid var(--deep-purple);
            min-width: 260px;
            z-index: 300;
            overflow: hidden;
            animation: dropDown 0.3s ease;
        }
        .settings-dropdown.open { display: block; }
        @keyframes dropDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .settings-header { background: linear-gradient(135deg, var(--deep-purple), var(--ocean-teal)); color: white; padding: 15px 20px; font-family: 'Bubblegum Sans', cursive; font-size: 1.2rem; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid rgba(155,89,182,0.15); cursor: pointer; transition: background 0.2s; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item:hover { background: rgba(155,89,182,0.1); }
        .settings-item-label { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .toggle-switch { width: 44px; height: 24px; background: #ddd; border-radius: 12px; position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
        .toggle-switch.on { background: var(--ocean-teal); }
        .toggle-switch::after { content: ''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: left 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .toggle-switch.on::after { left: 23px; }
        .settings-btn-item { width: 100%; background: none; border: none; cursor: pointer; font-family: 'Fredoka', sans-serif; }

        /* ===================== MAIN APP ===================== */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; display: none; }
        .container.active { display: block; }
        header { text-align: center; margin-bottom: 20px; animation: slideDown 0.8s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-family: 'Bubblegum Sans', cursive; font-size: 2.8rem; color: var(--deep-purple); text-shadow: 3px 3px 0 var(--sunshine-yellow), 6px 6px 0 var(--coral-pink); margin-bottom: 8px; }
        .tagline { font-size: 1.1rem; color: var(--text-secondary); font-weight: 600; }

        /* ===================== BLUETOOTH ===================== */
        .bluetooth-section { background: var(--card-bg); border-radius: 30px; padding: 20px; margin-bottom: 30px; box-shadow: var(--card-shadow); border: 4px solid var(--ocean-teal); text-align: center; transition: background 0.3s; }
        .bluetooth-btn { background: linear-gradient(135deg, var(--ocean-teal), var(--deep-purple)); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: 700; cursor: pointer; transition: all 0.3s; font-family: 'Fredoka', sans-serif; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .bluetooth-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .bluetooth-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .connection-status { margin-top: 15px; font-size: 1.1rem; font-weight: 600; }
        .status-connected { color: #2ecc71; }
        .status-disconnected { color: var(--coral-pink); }
        .waiting-measurement { background: linear-gradient(135deg, var(--sunshine-yellow), var(--rainbow-orange)); color: white; padding: 20px; border-radius: 20px; margin-top: 15px; font-size: 1.3rem; font-weight: 700; display: none; animation: pulse 1.5s ease-in-out infinite; }
        .waiting-measurement.active { display: block; }

        /* Manual entry row */
        .manual-entry-row { display: flex; gap: 10px; align-items: center; justify-content: center; margin-top: 15px; }
        .manual-entry-row input { max-width: 160px; margin: 0; }
        .manual-entry-row button { width: auto; margin: 0; padding: 14px 28px; font-size: 1rem; }

        /* ===================== PROFILES ===================== */
        .profile-section { background: var(--card-bg); border-radius: 30px; padding: 30px; margin-bottom: 30px; box-shadow: var(--card-shadow); border: 4px solid var(--coral-pink); transition: background 0.3s; }
        .profile-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        
        .profile-card { background: linear-gradient(135deg, var(--rainbow-red), var(--rainbow-orange)); border-radius: 20px; padding: 20px; cursor: pointer; transition: all 0.3s; color: white; text-align: center; border: 3px solid transparent; position: relative; }
        .profile-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .profile-card.active { border: 3px solid var(--sunshine-yellow); box-shadow: 0 0 20px rgba(255,215,0,0.5); }
        .profile-card .avatar { font-size: 3rem; margin-bottom: 10px; }
        .profile-card .name { font-family: 'Bubblegum Sans', cursive; font-size: 1.3rem; }
        .profile-card .stats { font-size: 0.9rem; margin-top: 5px; opacity: 0.9; }

        /* Profile action buttons */
        .profile-actions { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
        .profile-action-btn { background: rgba(255,255,255,0.3); border: 2px solid rgba(255,255,255,0.7); color: white; border-radius: 12px; padding: 5px 12px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; font-family: 'Fredoka', sans-serif; font-weight: 600; }
        .profile-action-btn:hover { background: rgba(255,255,255,0.5); transform: scale(1.05); }
        .profile-action-btn.delete-btn:hover { background: rgba(255,50,50,0.5); border-color: rgba(255,50,50,0.8); }
        .add-profile-btn { background: var(--card-bg) !important; color: var(--deep-purple) !important; border: 3px dashed var(--deep-purple) !important; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 3rem; }
        .add-profile-btn:hover { background: rgba(155,89,182,0.05) !important; }

        /* ===================== CARDS ===================== */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .card { background: var(--card-bg); border-radius: 30px; padding: 30px; box-shadow: var(--card-shadow); border: 4px solid var(--deep-purple); position: relative; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s, background 0.3s; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .card-title { font-family: 'Bubblegum Sans', cursive; font-size: 2rem; color: var(--coral-pink); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .emoji { font-size: 2.5rem; animation: bounce 2s ease-in-out infinite; }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .chart-container { position: relative; height: 300px; margin-top: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .stat-box { background: linear-gradient(135deg, var(--rainbow-green), var(--ocean-teal)); border-radius: 20px; padding: 20px; text-align: center; color: white; }
        .stat-number { font-size: 2.5rem; font-weight: 700; font-family: 'Bubblegum Sans', cursive; }
        .stat-label { font-size: 1rem; margin-top: 5px; }

        .history-list { max-height: 400px; overflow-y: auto; }
        .history-item { background: var(--history-bg); border-left: 5px solid var(--sunshine-yellow); padding: 15px; margin-bottom: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.5s ease-out; transition: background 0.3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

        .delete-measurement-btn { background: rgba(255,107,157,0.15); border: 2px solid var(--coral-pink); color: var(--coral-pink); border-radius: 10px; padding: 5px 12px; cursor: pointer; font-family: 'Fredoka', sans-serif; font-size: 0.85rem; transition: all 0.2s; }
        .delete-measurement-btn:hover { background: var(--coral-pink); color: white; }

        /* ===================== ACHIEVEMENTS ===================== */
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap: 15px; margin-top: 20px; }
        .achievement { background: var(--card-bg); border-radius: 20px; padding: 20px; text-align: center; border: 3px solid #ddd; transition: all 0.3s; }
        .achievement.unlocked { border-color: var(--sunshine-yellow); background: linear-gradient(135deg, var(--sunshine-yellow), var(--rainbow-orange)); color: white; transform: scale(1.05); box-shadow: 0 5px 15px rgba(255,215,0,0.5); }
        .achievement.locked { opacity: 0.5; filter: grayscale(100%); }
        .achievement-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .achievement-name { font-size: 0.9rem; font-weight: 600; }

        /* ===================== MODALS ===================== */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); border-radius: 30px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 4px solid var(--deep-purple); max-height: 90vh; overflow-y: auto; animation: popIn 0.3s ease; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .modal-title { font-family: 'Bubblegum Sans', cursive; font-size: 2rem; color: var(--deep-purple); margin-bottom: 20px; text-align: center; }
        .avatar-selector { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin: 20px 0; max-height: 220px; overflow-y: auto; }
        .avatar-option { font-size: 2.5rem; padding: 15px; border-radius: 15px; cursor: pointer; text-align: center; border: 3px solid transparent; transition: all 0.3s; }
        .avatar-option:hover { background: var(--cloud-white); transform: scale(1.1); }
        .avatar-option.selected { border: 3px solid var(--sunshine-yellow); background: rgba(255,215,0,0.1); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: #ccc; color: #333; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        /* Confirm delete modal */
        .confirm-delete-text { text-align: center; font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 20px; }
        .confirm-delete-name { font-size: 1.5rem; font-weight: 700; color: var(--coral-pink); }

        /* ===================== UTILITIES ===================== */
        .loading-spinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 60px; height: 60px; border: 6px solid rgba(200,200,200,0.3); border-top: 6px solid var(--coral-pink); border-radius: 50%; animation: spin 1s linear infinite; z-index: 10000; }
        .loading-spinner.active { display: block; }
        @keyframes spin { 0% { transform: translate(-50%,-50%) rotate(0deg); } 100% { transform: translate(-50%,-50%) rotate(360deg); } }
        .error-message { background: var(--coral-pink); color: white; padding: 15px; border-radius: 15px; margin: 10px 0; text-align: center; font-weight: 600; }
        .success-message { background: var(--rainbow-green); color: white; padding: 15px; border-radius: 15px; margin: 10px 0; text-align: center; font-weight: 600; }
        .confetti { position: fixed; width: 10px; height: 10px; border-radius: 50%; animation: fall 3s linear; pointer-events: none; z-index: 9999; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

        /* ===================== EXPORT BUTTON ===================== */
        .export-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 10px 25px; border-radius: 20px; font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-top: 10px; }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* ===================== GROWTH MILESTONE BANNER ===================== */
        .milestone-banner { background: linear-gradient(135deg, var(--deep-purple), var(--coral-pink)); color: white; border-radius: 20px; padding: 18px 25px; margin-bottom: 20px; display: none; align-items: center; gap: 15px; font-size: 1.2rem; font-weight: 700; animation: slideDown 0.5s ease; }
        .milestone-banner.show { display: flex; }
        .milestone-banner .close-banner { margin-left: auto; cursor: pointer; font-size: 1.3rem; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 10px; padding: 4px 10px; font-family: 'Fredoka', sans-serif; }

        /* ===================== RESPONSIVE ===================== */
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
            .login-card { padding: 30px; }
            .profile-selector { grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); }
            .card { padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-brand { font-size: 1.2rem; }
            .manual-entry-row { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="sun"></div>
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="loading-spinner" id="loadingSpinner"></div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-title">üåà HeightMate üåà</div>
            <div class="login-subtitle">Track Your Family's Growth!</div>
            <div id="authMessage"></div>
            <div id="loginForm">
                <input type="email" class="input-field" id="loginEmail" placeholder="Email Address">
                <input type="password" class="input-field" id="loginPassword" placeholder="Password">
                <button class="btn" onclick="handleLogin()">üîë Login</button>
                <p class="toggle-auth" onclick="toggleAuthMode()">Don't have an account? Sign up!</p>
            </div>
            <div id="signupForm" style="display:none;">
                <input type="text" class="input-field" id="signupFamilyName" placeholder="Family Name (e.g., Smith Family)">
                <input type="email" class="input-field" id="signupEmail" placeholder="Email Address">
                <input type="password" class="input-field" id="signupPassword" placeholder="Password (min 6 characters)">
                <button class="btn" onclick="handleSignup()">üéâ Create Account</button>
                <p class="toggle-auth" onclick="toggleAuthMode()">Already have an account? Login!</p>
            </div>
        </div>
    </div>

    <!-- TOP NAV -->
    <nav class="top-nav" id="topNav">
        <div class="nav-brand" id="navFamilyName">üåà HeightMate Pro</div>
        <div class="nav-actions">
            <button class="nav-btn" title="Export Data" onclick="exportData()">üì§</button>
            <button class="nav-btn" title="Settings" onclick="toggleSettings()" id="settingsBtn">‚öôÔ∏è</button>
            <button class="nav-btn" title="Logout" onclick="handleLogout()">üëã</button>
        </div>
        <!-- Settings Dropdown -->
        <div class="settings-dropdown" id="settingsDropdown">
            <div class="settings-item settings-btn-item" onclick="openEditFamilyModal(); toggleSettings();">
                <span class="settings-item-label">‚úèÔ∏è Edit Family Name</span>
                <span>‚Üí</span>
            </div>

            <div class="settings-header">‚öôÔ∏è Settings</div>
            <div class="settings-item">
                <span class="settings-item-label">üåô Dark Mode</span>
                <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()"></div>
            </div>
            <div class="settings-item">
                <span class="settings-item-label">üéâ Confetti Effects</span>
                <div class="toggle-switch on" id="confettiToggle" onclick="toggleConfetti()"></div>
            </div>
            <div class="settings-item">
                <span class="settings-item-label">üîî Growth Notifications</span>
                <div class="toggle-switch on" id="notifToggle" onclick="toggleNotif()"></div>
            </div>
            <div class="settings-item settings-btn-item" onclick="exportData(); toggleSettings();">
                <span class="settings-item-label">üì§ Export All Data (CSV)</span>
                <span>‚Üí</span>
            </div>
            <div class="settings-item settings-btn-item" onclick="handleLogout();">
                <span class="settings-item-label" style="color:var(--coral-pink);">üëã Logout</span>
                <span>‚Üí</span>
            </div>
        </div>
    </nav>

    <!-- MAIN APP -->
    <div class="container" id="mainApp">
        <header>
            <h1 id="familyName">üåà HeightMate Pro üåà</h1>
            <p class="tagline">Track Every Kid's Amazing Growth Journey! üìè‚ú®</p>
        </header>

        <!-- Milestone Banner -->
        <div class="milestone-banner" id="milestoneBanner">
            <span id="milestoneText"></span>
            <button class="close-banner" onclick="document.getElementById('milestoneBanner').classList.remove('show')">‚úï</button>
        </div>

        <!-- Bluetooth / Manual Entry -->
        <div class="bluetooth-section">
            <h3 style="font-family:'Bubblegum Sans',cursive;color:var(--ocean-teal);margin-bottom:15px;">üì± Add a Measurement</h3>
            <button class="bluetooth-btn" id="bluetoothBtn" onclick="connectBluetooth()">üîµ Connect via Bluetooth</button>
            <div class="connection-status" id="connectionStatus"><span class="status-disconnected">‚ö™ Not Connected</span></div>
            <div class="waiting-measurement" id="waitingMeasurement">üìè Ready! Stand under the device and press the button...</div>
            <div class="manual-entry-row" style="margin-top:20px;">
                <input type="number" class="input-field" id="manualHeight" placeholder="Enter height (cm)" min="50" max="250" step="0.1">
                <button class="btn" onclick="addManualHeight()" style="width:auto;margin:0;">‚úèÔ∏è Add Manually</button>
            </div>
        </div>

        <!-- Profiles -->
        <div class="profile-section">
            <h3 style="font-family:'Bubblegum Sans',cursive;color:var(--coral-pink);margin-bottom:20px;">üë∂ Kid Profiles</h3>
            <div class="profile-selector" id="profileSelector"></div>
        </div>

        <!-- Grid -->
        <div class="main-grid">
            <div class="card">
                <div class="card-title"><span class="emoji">üìä</span>Growth Stats</div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-number" id="totalMeasurements">0</div><div class="stat-label">Total Checks</div></div>
                    <div class="stat-box"><div class="stat-number" id="totalGrowth">0</div><div class="stat-label">cm Grown!</div></div>
                    <div class="stat-box"><div class="stat-number" id="currentHeight">--</div><div class="stat-label">Current Height</div></div>
                    <div class="stat-box"><div class="stat-number" id="avgGrowth">0</div><div class="stat-label">cm/month</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><span class="emoji">üèÜ</span>Achievements</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
            <div class="card" style="grid-column:span 2;">
                <div class="card-title"><span class="emoji">üìà</span>Growth Chart</div>
                <div class="chart-container"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="card" style="grid-column:span 2;">
                <div class="card-title" style="justify-content:space-between;">
                    <span style="display:flex;align-items:center;gap:10px;"><span class="emoji">üìú</span>Measurement History</span>
                    <button class="export-btn" onclick="exportProfileData()">üì• Export CSV</button>
                </div>
                <div class="history-list" id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- ADD PROFILE MODAL -->
    <div class="modal" id="addProfileModal">
        <div class="modal-content">
            <div class="modal-title">Add New Kid Profile üé®</div>
            <label style="display:block;margin-bottom:8px;font-weight:600;">Name:</label>
            <input type="text" class="input-field" id="newProfileName" placeholder="Kid's name">
            <label style="display:block;margin:12px 0 8px;font-weight:600;">Age:</label>
            <input type="number" class="input-field" id="newProfileAge" placeholder="Age" min="1" max="20">
            <label style="display:block;margin:12px 0 8px;font-weight:600;">Choose Avatar:</label>
            <div class="avatar-selector" id="avatarSelector"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeAddProfileModal()">Cancel</button>
                <button class="btn" style="flex:1;" onclick="saveNewProfile()">Create! üéâ</button>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-title">Edit Profile ‚úèÔ∏è</div>
            <label style="display:block;margin-bottom:8px;font-weight:600;">Name:</label>
            <input type="text" class="input-field" id="editProfileName" placeholder="Kid's name">
            <label style="display:block;margin:12px 0 8px;font-weight:600;">Age:</label>
            <input type="number" class="input-field" id="editProfileAge" placeholder="Age" min="1" max="20">
            <label style="display:block;margin:12px 0 8px;font-weight:600;">Choose Avatar:</label>
            <div class="avatar-selector" id="editAvatarSelector"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeEditProfileModal()">Cancel</button>
                <button class="btn" style="flex:1;" onclick="saveEditProfile()">Save Changes üíæ</button>
            </div>
        </div>
    </div>

    <!-- EDIT FAMILY NAME MODAL -->
    <div class="modal" id="editFamilyModal">
        <div class="modal-content">
            <div class="modal-title">Edit Family Name ‚úèÔ∏è</div>

            <label style="display:block;margin-bottom:8px;font-weight:600;">
                Family Name:
            </label>

            <input type="text"
                   class="input-field"
                   id="editFamilyNameInput"
                   placeholder="Enter new family name">

            <div class="modal-buttons">
                <button class="btn btn-secondary"
                        style="flex:1;"
                        onclick="closeEditFamilyModal()">
                    Cancel
                </button>

                <button class="btn"
                        style="flex:1;"
                        onclick="saveFamilyName()">
                    Save üíæ
                </button>
            </div>
        </div>
    </div>


    <!-- DELETE PROFILE CONFIRM MODAL -->
    <div class="modal" id="deleteProfileModal">
        <div class="modal-content">
            <div class="modal-title">Delete Profile üóëÔ∏è</div>
            <p class="confirm-delete-text">Are you sure you want to delete<br><span class="confirm-delete-name" id="deleteProfileNameDisplay"></span>?<br><br>‚ö†Ô∏è All measurements will be permanently lost!</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" style="flex:1;" onclick="closeDeleteProfileModal()">Cancel</button>
                <button class="btn btn-danger" style="flex:1;" onclick="confirmDeleteProfile()">Delete üóëÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // FIREBASE CONFIG
    // ============================================
    const firebaseConfig = {
        apiKey: "AIzaSyABPDlqhPeLMgmA7CTpmHi7xhRqXGxPwM0",
        authDomain: "heightmatepro.firebaseapp.com",
        projectId: "heightmatepro",
        storageBucket: "heightmatepro.firebasestorage.app",
        messagingSenderId: "435638185961",
        appId: "1:435638185961:web:656c2e19f8dadc2e3a6578",
        measurementId: "G-WRLKW6H6E4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ============================================
    // GLOBALS
    // ============================================
    let currentUser = null, currentFamilyId = null;
    let profiles = [], currentProfileId = null;
    let bluetoothDevice = null, bluetoothCharacteristic = null;
    let growthChart = null;
    let editingProfileId = null, deletingProfileId = null;
    let settingsOpen = false;

    // Settings state
    let settings = {
        darkMode: false,
        confetti: true,
        notifications: true
    };

    const avatarOptions = ['üë¶','üëß','üßí','üë∂','üßë','üë®','üë©','ü¶∏','ü¶π','üßö','üßô','ü§¥','üë∏','üßù','üßõ','üêª','ü¶ä','üêº','ü¶Å','üêØ','üêß','ü¶ã','üåü','‚≠ê'];

    const achievements = [
        { id: 'first',      name: 'First Step!',       icon: 'üë£', type: 'measurements', threshold: 1 },
        { id: 'growing',    name: 'Growing Up!',        icon: 'üå±', type: 'growth',        threshold: 1 },
        { id: 'tall5',      name: '5cm Taller!',        icon: 'üìè', type: 'growth',        threshold: 5 },
        { id: 'tall10',     name: '10cm Taller!',       icon: 'üéØ', type: 'growth',        threshold: 10 },
        { id: 'consistent', name: 'Regular Tracker!',   icon: '‚≠ê', type: 'measurements', threshold: 5 },
        { id: 'dedicated',  name: 'Dedicated!',         icon: 'üí™', type: 'measurements', threshold: 10 },
        { id: 'champion',   name: 'Growth Champion!',   icon: 'üèÜ', type: 'growth',        threshold: 15 },
        { id: 'superstar',  name: 'Superstar!',         icon: 'üåü', type: 'measurements', threshold: 20 }
    ];

    // ============================================
    // AUTH
    // ============================================
    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            loadSettingsFromStorage();
            await loadFamilyData();
            showMainApp();
        } else {
            showLoginScreen();
        }
    });

    function toggleAuthMode() {
        const lf = document.getElementById('loginForm'), sf = document.getElementById('signupForm');
        if (lf.style.display === 'none') { lf.style.display = 'block'; sf.style.display = 'none'; }
        else { lf.style.display = 'none'; sf.style.display = 'block'; }
        document.getElementById('authMessage').innerHTML = '';
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) { showAuthMessage('Please fill in all fields!', 'error'); return; }
        showLoading(true);
        try { await auth.signInWithEmailAndPassword(email, password); }
        catch (e) { 
           console.log("LOGIN ERROR:", e);
           alert(e.code);
        }

        finally { showLoading(false); }
    }

    async function handleSignup() {
        const familyName = document.getElementById('signupFamilyName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const password = document.getElementById('signupPassword').value;
        if (!familyName || !email || !password) { showAuthMessage('Please fill in all fields!', 'error'); return; }
        if (password.length < 6) { showAuthMessage('Password must be at least 6 characters!', 'error'); return; }
        showLoading(true);
        try {
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('families').doc(cred.user.uid).set({ familyName, email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        } catch (e) { showAuthMessage(getAuthErrorMessage(e.code), 'error'); }
        finally { showLoading(false); }
    }

    async function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            await auth.signOut();
            if (bluetoothDevice && bluetoothDevice.gatt.connected) await bluetoothDevice.gatt.disconnect();
        }
    }

    function showAuthMessage(msg, type) {
        const el = document.getElementById('authMessage');
        el.className = type === 'error' ? 'error-message' : 'success-message';
        el.textContent = msg;
        setTimeout(() => el.innerHTML = '', 5000);
    }

    function getAuthErrorMessage(code) {
        const map = {
            'auth/email-already-in-use': 'This email is already registered!',
            'auth/invalid-email': 'Invalid email address!',
            'auth/weak-password': 'Password is too weak!',
            'auth/user-not-found': 'No account found with this email!',
            'auth/wrong-password': 'Incorrect password!'
        };
        return map[code] || 'An error occurred. Please try again!';
    }

    function showLoginScreen() { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('mainApp').classList.remove('active'); document.getElementById('topNav').classList.remove('active'); }
    function showMainApp() { document.getElementById('loginScreen').style.display = 'none'; document.getElementById('mainApp').classList.add('active'); document.getElementById('topNav').classList.add('active'); }
    function showLoading(show) { document.getElementById('loadingSpinner').classList.toggle('active', show); }

    // ============================================
    // SETTINGS
    // ============================================
    function loadSettingsFromStorage() {
        const saved = localStorage.getItem('heightmate_settings');
        if (saved) settings = { ...settings, ...JSON.parse(saved) };
        applySettings();
    }

    function saveSettingsToStorage() {
        localStorage.setItem('heightmate_settings', JSON.stringify(settings));
    }

    function applySettings() {
        document.body.classList.toggle('dark-mode', settings.darkMode);
        document.getElementById('darkModeToggle').classList.toggle('on', settings.darkMode);
        document.getElementById('confettiToggle').classList.toggle('on', settings.confetti);
        document.getElementById('notifToggle').classList.toggle('on', settings.notifications);
    }

    function toggleSettings() {
        settingsOpen = !settingsOpen;
        document.getElementById('settingsDropdown').classList.toggle('open', settingsOpen);
        document.getElementById('settingsBtn').classList.toggle('active-btn', settingsOpen);
    }

    function toggleDarkMode() {
        settings.darkMode = !settings.darkMode;
        applySettings();
        saveSettingsToStorage();
    }

    function toggleConfetti() {
        settings.confetti = !settings.confetti;
        applySettings();
        saveSettingsToStorage();
    }

    function toggleNotif() {
        settings.notifications = !settings.notifications;
        applySettings();
        saveSettingsToStorage();
    }

    // Close settings when clicking outside
    document.addEventListener('click', e => {
        if (settingsOpen && !e.target.closest('#settingsDropdown') && !e.target.closest('#settingsBtn')) {
            settingsOpen = false;
            document.getElementById('settingsDropdown').classList.remove('open');
            document.getElementById('settingsBtn').classList.remove('active-btn');
        }
    });

    // ============================================
    // FIRESTORE DATA
    // ============================================
    async function loadFamilyData() {
        showLoading(true);
        try {
            currentFamilyId = currentUser.uid;
            const fDoc = await db.collection('families').doc(currentFamilyId).get();
            if (fDoc.exists) {
                const name = fDoc.data().familyName;
                document.getElementById('familyName').textContent = `üåà ${name} üåà`;
                document.getElementById('navFamilyName').textContent = `üåà ${name}`;
            }
            await loadProfiles();
        } catch (e) {
            console.error(e);
            alert('Error loading data. Please refresh.');
        } finally { showLoading(false); }
    }

    async function loadProfiles() {
        try {
            const snap = await db.collection('families').doc(currentFamilyId).collection('profiles').orderBy('createdAt', 'asc').get();
            profiles = [];
            snap.forEach(doc => profiles.push({ id: doc.id, ...doc.data() }));
            renderProfiles();
            if (profiles.length > 0 && !currentProfileId) loadProfile(profiles[0].id);
        } catch (e) { console.error(e); }
    }

    async function saveNewProfile() {
        const name = document.getElementById('newProfileName').value.trim();
        const age = parseInt(document.getElementById('newProfileAge').value);
        const sel = document.querySelector('#avatarSelector .avatar-option.selected');
        if (!name || !age || !sel) { alert('Please fill in all fields and select an avatar! üòä'); return; }
        showLoading(true);
        try {
            const colors = [['#FF6B6B','#FFA500'],['#4ECDC4','#44A08D'],['#9B59B6','#E74C3C'],['#3498DB','#2ECC71'],['#F39C12','#E67E22']];
            const rc = colors[Math.floor(Math.random() * colors.length)];
            const ref = await db.collection('families').doc(currentFamilyId).collection('profiles').add({ name, age, avatar: sel.textContent, color1: rc[0], color2: rc[1], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            closeAddProfileModal();
            await loadProfiles();
            loadProfile(ref.id);
            if (settings.confetti) createConfetti();
        } catch (e) { console.error(e); alert('Error creating profile.'); }
        finally { showLoading(false); }
    }

    // ---- EDIT PROFILE ----
    function openEditProfileModal(profileId, e) {
        e.stopPropagation();
        editingProfileId = profileId;
        const p = profiles.find(x => x.id === profileId);
        if (!p) return;
        document.getElementById('editProfileName').value = p.name;
        document.getElementById('editProfileAge').value = p.age;
        renderAvatarSelectorInEl('editAvatarSelector', p.avatar);
        document.getElementById('editProfileModal').classList.add('active');
    }

    function closeEditProfileModal() { document.getElementById('editProfileModal').classList.remove('active'); editingProfileId = null; }

    async function saveEditProfile() {
        const name = document.getElementById('editProfileName').value.trim();
        const age = parseInt(document.getElementById('editProfileAge').value);
        const sel = document.querySelector('#editAvatarSelector .avatar-option.selected');
        if (!name || !age || !sel) { alert('Please fill in all fields and select an avatar! üòä'); return; }
        showLoading(true);
        try {
            await db.collection('families').doc(currentFamilyId).collection('profiles').doc(editingProfileId).update({ name, age, avatar: sel.textContent });
            closeEditProfileModal();
            await loadProfiles();
            if (currentProfileId === editingProfileId) await loadMeasurements();
            showNotification('‚úÖ Profile updated!');
        } catch (e) { console.error(e); alert('Error updating profile.'); }
        finally { showLoading(false); }
    }

    // ---- DELETE PROFILE ----
    function openDeleteProfileModal(profileId, e) {
        e.stopPropagation();
        deletingProfileId = profileId;
        const p = profiles.find(x => x.id === profileId);
        document.getElementById('deleteProfileNameDisplay').textContent = p ? p.name : '';
        document.getElementById('deleteProfileModal').classList.add('active');
    }

    function closeDeleteProfileModal() { document.getElementById('deleteProfileModal').classList.remove('active'); deletingProfileId = null; }

    async function confirmDeleteProfile() {
        if (!deletingProfileId) return;
        showLoading(true);
        try {
            // Delete all measurements subcollection first
            const measSnap = await db.collection('families').doc(currentFamilyId).collection('profiles').doc(deletingProfileId).collection('measurements').get();
            const batch = db.batch();
            measSnap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            // Delete profile doc
            await db.collection('families').doc(currentFamilyId).collection('profiles').doc(deletingProfileId).delete();
            if (currentProfileId === deletingProfileId) currentProfileId = null;
            closeDeleteProfileModal();
            await loadProfiles();
            showNotification('üóëÔ∏è Profile deleted.');
        } catch (e) { console.error(e); alert('Error deleting profile.'); }
        finally { showLoading(false); }
    }

    async function loadProfile(profileId) {
        currentProfileId = profileId;
        renderProfiles();
        await loadMeasurements();
    }

    async function loadMeasurements() {
        if (!currentProfileId) return;
        try {
            const snap = await db.collection('families').doc(currentFamilyId).collection('profiles').doc(currentProfileId).collection('measurements').orderBy('timestamp', 'asc').get();
            const profile = profiles.find(p => p.id === currentProfileId);
            if (!profile) return;
            profile.measurements = [];
            snap.forEach(doc => profile.measurements.push({ id: doc.id, ...doc.data() }));
            updateDisplay();
        } catch (e) { console.error(e); }
    }

    async function saveMeasurement(height) {
        if (!currentProfileId) { alert('Please select a profile first! üë∂'); return; }
        const profile = getCurrentProfile();
        try {
            const meas = { height, age: profile.age, date: new Date().toISOString().split('T')[0], timestamp: firebase.firestore.FieldValue.serverTimestamp() };
            await db.collection('families').doc(currentFamilyId).collection('profiles').doc(currentProfileId).collection('measurements').add(meas);
            await loadMeasurements();
            if (settings.confetti) createConfetti();
            if (settings.notifications) showNotification(`üìè ${height}cm recorded for ${profile.name}! üéâ`);
            checkMilestones(profile);
        } catch (e) { console.error(e); alert('Error saving measurement.'); }
    }

    async function deleteMeasurement(measurementId, e) {
        e.stopPropagation();
        if (!confirm('Delete this measurement?')) return;
        try {
            await db.collection('families').doc(currentFamilyId).collection('profiles').doc(currentProfileId).collection('measurements').doc(measurementId).delete();
            await loadMeasurements();
            showNotification('üóëÔ∏è Measurement deleted.');
        } catch (e) { console.error(e); alert('Error deleting measurement.'); }
    }

    // ============================================
    // MANUAL HEIGHT ENTRY
    // ============================================
    function addManualHeight() {
        const val = parseFloat(document.getElementById('manualHeight').value);
        if (isNaN(val) || val < 50 || val > 250) { alert('Please enter a valid height between 50 and 250 cm!'); return; }
        if (!currentProfileId) { alert('Please select a profile first! üë∂'); return; }
        saveMeasurement(val);
        document.getElementById('manualHeight').value = '';
    }

    // ============================================
    // MILESTONES
    // ============================================
    function checkMilestones(profile) {
        const m = profile.measurements || [];
        if (m.length < 2) return;
        const last = m[m.length - 1].height, prev = m[m.length - 2].height;
        const diff = (last - prev).toFixed(1);
        if (diff > 0) {
            const milestones = [{ threshold: 5, msg: 'üöÄ Amazing! 5cm growth milestone reached!' }, { threshold: 3, msg: 'üåü Great growth spurt!' }, { threshold: 1, msg: 'üìè Every centimetre counts!' }];
            const total = last - m[0].height;
            const banner = document.getElementById('milestoneBanner');
            const text = document.getElementById('milestoneText');
            for (const ms of [{ threshold: 20, msg: 'üëë 20cm total growth - SUPERSTAR!' }, { threshold: 15, msg: 'üèÜ 15cm total growth - CHAMPION!' }, { threshold: 10, msg: 'üéØ 10cm total growth milestone!' }, { threshold: 5, msg: 'üìè 5cm total growth milestone!'}]) {
                if (Math.floor(total) >= ms.threshold && Math.floor(total) < ms.threshold + (last - prev)) {
                    text.textContent = ms.msg;
                    banner.classList.add('show');
                    return;
                }
            }
        }
    }

    // ============================================
    // BLUETOOTH
    // ============================================
    async function connectBluetooth() {
        try {
            const btn = document.getElementById('bluetoothBtn');
            btn.disabled = true; btn.textContent = 'üîÑ Connecting...';
            bluetoothDevice = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'ESP32' }, { namePrefix: 'HeightMate' }], optionalServices: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b'] });
            const server = await bluetoothDevice.gatt.connect();
            const service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
            bluetoothCharacteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
            await bluetoothCharacteristic.startNotifications();
            bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleHeightData);
            btn.textContent = '‚úÖ Connected!';
            document.getElementById('connectionStatus').innerHTML = '<span class="status-connected">üü¢ Connected to HeightMate Device</span>';
            document.getElementById('waitingMeasurement').classList.add('active');
            setTimeout(() => { btn.textContent = 'üîå Disconnect'; btn.disabled = false; btn.onclick = disconnectBluetooth; }, 2000);
        } catch (error) {
            let msg = 'Could not connect. ';
            if (error.name === 'SecurityError') msg += 'Bluetooth requires HTTPS!';
            else if (error.name === 'NotFoundError') msg += 'No HeightMate device found nearby!';
            else msg += 'Make sure your device is powered on!';
            alert(msg);
            const btn = document.getElementById('bluetoothBtn');
            btn.textContent = 'üîµ Connect via Bluetooth'; btn.disabled = false;
        }
    }

    async function disconnectBluetooth() {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
            await bluetoothDevice.gatt.disconnect();
            document.getElementById('bluetoothBtn').textContent = 'üîµ Connect via Bluetooth';
            document.getElementById('bluetoothBtn').onclick = connectBluetooth;
            document.getElementById('connectionStatus').innerHTML = '<span class="status-disconnected">‚ö™ Not Connected</span>';
            document.getElementById('waitingMeasurement').classList.remove('active');
        }
    }

    function handleHeightData(event) {
        const decoder = new TextDecoder('utf-8');
        const data = decoder.decode(event.target.value);
        let height = data.includes('HEIGHT:') ? parseFloat(data.replace('HEIGHT:', '').trim()) : parseFloat(data.trim());
        if (!isNaN(height) && height > 0 && height < 300) saveMeasurement(height);
    }

    // ============================================
    // EXPORT
    // ============================================
    function exportData() {
        if (!profiles.length) { alert('No profiles to export!'); return; }
        let csv = 'Profile,Avatar,Age,Date,Height (cm)\n';
        profiles.forEach(p => {
            const meas = p.measurements || [];
            if (meas.length === 0) csv += `${p.name},${p.avatar},${p.age},,,\n`;
            else meas.forEach(m => { csv += `${p.name},${p.avatar},${m.age},${m.date},${m.height}\n`; });
        });
        downloadCSV(csv, 'heightmate_all_data.csv');
        showNotification('üì§ All data exported!');
    }

    function exportProfileData() {
        const profile = getCurrentProfile();
        if (!profile) { alert('No profile selected!'); return; }
        const meas = profile.measurements || [];
        if (!meas.length) { alert('No measurements to export!'); return; }
        let csv = `HeightMate Pro - ${profile.name}\nDate,Height (cm),Age\n`;
        meas.forEach(m => { csv += `${m.date},${m.height},${m.age}\n`; });
        downloadCSV(csv, `${profile.name.replace(/ /g,'_')}_heights.csv`);
        showNotification(`üì• ${profile.name}'s data exported!`);
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderProfiles() {
        const sel = document.getElementById('profileSelector');
        sel.innerHTML = profiles.map(p => `
            <div class="profile-card ${p.id === currentProfileId ? 'active' : ''}"
                 onclick="loadProfile('${p.id}')"
                 style="background:linear-gradient(135deg,${p.color1},${p.color2});">
                <div class="avatar">${p.avatar}</div>
                <div class="name">${p.name}</div>
                <div class="stats">${p.measurements?.length || 0} measurements</div>
                <div class="profile-actions">
                    <button class="profile-action-btn" onclick="openEditProfileModal('${p.id}', event)" title="Edit Profile">‚úèÔ∏è Edit</button>
                    <button class="profile-action-btn delete-btn" onclick="openDeleteProfileModal('${p.id}', event)" title="Delete Profile">üóëÔ∏è Delete</button>
                </div>
            </div>
        `).join('') + `<div class="profile-card add-profile-btn" onclick="openAddProfileModal()"><div>‚ûï</div><div style="font-size:1rem;margin-top:5px;font-weight:600;">Add Kid</div></div>`;
    }

    function openAddProfileModal() {
        document.getElementById('addProfileModal').classList.add('active');
        document.getElementById('newProfileName').value = '';
        document.getElementById('newProfileAge').value = '';
        renderAvatarSelectorInEl('avatarSelector', null);
    }

    function closeAddProfileModal() { document.getElementById('addProfileModal').classList.remove('active'); }

    function renderAvatarSelectorInEl(elId, selectedAvatar) {
        const el = document.getElementById(elId);
        el.innerHTML = avatarOptions.map(a => `<div class="avatar-option ${a === selectedAvatar ? 'selected' : ''}" onclick="selectAvatarIn('${elId}', event)">${a}</div>`).join('');
    }

    function selectAvatarIn(elId, e) {
        document.querySelectorAll(`#${elId} .avatar-option`).forEach(x => x.classList.remove('selected'));
        e.target.classList.add('selected');
    }

    function getCurrentProfile() { return profiles.find(p => p.id === currentProfileId); }

    function updateDisplay() {
        const profile = getCurrentProfile();
        if (!profile) return;
        updateStats(profile);
        updateHistory(profile);
        updateChart(profile);
        updateAchievements(profile);
    }

    function updateStats(profile) {
        const m = profile.measurements || [];
        document.getElementById('totalMeasurements').textContent = m.length;
        if (m.length > 0) {
            const cur = m[m.length - 1].height;
            document.getElementById('currentHeight').textContent = cur + 'cm';
            if (m.length > 1) {
                const growth = (cur - m[0].height).toFixed(1);
                document.getElementById('totalGrowth').textContent = growth;
                const months = (new Date(m[m.length-1].date) - new Date(m[0].date)) / (1000*60*60*24*30);
                document.getElementById('avgGrowth').textContent = months > 0 ? (growth / months).toFixed(2) : '0';
            } else { document.getElementById('totalGrowth').textContent = '0'; document.getElementById('avgGrowth').textContent = '0'; }
        } else { document.getElementById('currentHeight').textContent = '--'; document.getElementById('totalGrowth').textContent = '0'; document.getElementById('avgGrowth').textContent = '0'; }
    }

    function updateHistory(profile) {
        const list = document.getElementById('historyList');
        const m = [...(profile.measurements || [])].reverse();
        if (!m.length) { list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No measurements yet! Add one above! üìè</p>'; return; }
        list.innerHTML = m.map((item, i) => {
            let growthText = '';
            if (i < m.length - 1) {
                const diff = (item.height - m[i+1].height).toFixed(1);
                growthText = diff > 0 ? `<span style="color:var(--rainbow-green);">+${diff}cm üìà</span>` : diff < 0 ? `<span style="color:var(--coral-pink);">${diff}cm</span>` : '';
            }
            return `<div class="history-item">
                <div>
                    <strong>${new Date(item.date).toLocaleDateString()}</strong><br>
                    <small style="color:var(--text-secondary);">Age: ${item.age} years</small>
                </div>
                <div style="text-align:right;display:flex;align-items:center;gap:12px;">
                    <div><strong style="font-size:1.5rem;">${item.height}cm</strong><br>${growthText}</div>
                    <button class="delete-measurement-btn" onclick="deleteMeasurement('${item.id}', event)">üóëÔ∏è</button>
                </div>
            </div>`;
        }).join('');
    }

    function updateChart(profile) {
        const m = profile.measurements || [];
        const ctx = document.getElementById('growthChart').getContext('2d');
        if (growthChart) growthChart.destroy();
        if (!m.length) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); return; }
        const labels = m.map(x => new Date(x.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }));
        growthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: `${profile.name}'s Height (cm)`,
                    data: m.map(x => x.height),
                    borderColor: profile.color1,
                    backgroundColor: profile.color2 + '30',
                    borderWidth: 3, fill: true, tension: 0.4,
                    pointRadius: 6, pointHoverRadius: 9,
                    pointBackgroundColor: profile.color1,
                    pointBorderColor: '#fff', pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { font: { family: 'Fredoka', size: 14 }, color: settings.darkMode ? '#ccc' : '#333' } } },
                scales: {
                    y: { beginAtZero: false, ticks: { font: { family: 'Fredoka' }, color: settings.darkMode ? '#aaa' : '#555' }, grid: { color: settings.darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' } },
                    x: { ticks: { font: { family: 'Fredoka' }, color: settings.darkMode ? '#aaa' : '#555', maxRotation: 45, minRotation: 45 }, grid: { color: settings.darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } }
                }
            }
        });
    }

    function updateAchievements(profile) {
        const grid = document.getElementById('achievementsGrid');
        const m = profile.measurements || [];
        grid.innerHTML = achievements.map(a => {
            let unlocked = false;
            if (a.type === 'growth' && m.length > 1) unlocked = (m[m.length-1].height - m[0].height) >= a.threshold;
            else if (a.type === 'measurements') unlocked = m.length >= a.threshold;
            return `<div class="achievement ${unlocked ? 'unlocked' : 'locked'}">
                <div class="achievement-icon">${unlocked ? a.icon : 'üîí'}</div>
                <div class="achievement-name">${a.name}</div>
            </div>`;
        }).join('');
    }

    // ============================================
    // UTILITIES
    // ============================================
    function showNotification(msg) {
        const n = document.createElement('div');
        n.style.cssText = 'position:fixed;top:75px;right:20px;background:linear-gradient(135deg,var(--ocean-teal),var(--deep-purple));color:white;padding:16px 24px;border-radius:20px;font-size:1.1rem;font-weight:700;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,0.3);animation:slideIn 0.4s ease;max-width:320px;';
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => { n.style.opacity = '0'; n.style.transform = 'translateX(30px)'; n.style.transition = 'all 0.4s'; setTimeout(() => n.remove(), 400); }, 3000);
    }

    function createConfetti() {
        const colors = ['#FFD700','#FF6B9D','#90EE90','#87CEEB','#9B59B6','#FF6B6B','#4ECDC4'];
        for (let i = 0; i < 60; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.cssText = `left:${Math.random()*100}vw;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};animation-delay:${Math.random()*0.5}s;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>0.5?'50%':'3px'};`;
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3500);
            }, i * 40);
        }
    }
     
    // ===============================
    // EDIT FAMILY NAME  
    // ===============================

    function openEditFamilyModal() {
        const currentName = document.getElementById('familyName').textContent.replace(/üåà/g, '').trim();
        document.getElementById('editFamilyNameInput').value = currentName;
        document.getElementById('editFamilyModal').classList.add('active');
    }

    function closeEditFamilyModal() {
        document.getElementById('editFamilyModal').classList.remove('active');
     }

    async function saveFamilyName() {
        const newName = document.getElementById('editFamilyNameInput').value.trim();

        if (!newName) {
           alert("Family name cannot be empty!");
           return;
        }

        showLoading(true);

        try {
            await db.collection('families')
                .doc(currentFamilyId)
                .update({
                    familyName: newName
                });

            // Update UI instantly
            document.getElementById('familyName').textContent = `üåà ${newName} üåà`;
            document.getElementById('navFamilyName').textContent = `üåà ${newName}`;

            closeEditFamilyModal();
            showNotification("‚úÖ Family name updated!");
s
        } catch (error) {
            console.error(error);
            alert("Error updating family name.");
        }

        showLoading(false);
    }

    </script>
</body>
</html>